<!doctype html>
<html lang="en">
  <head>
    <%- include('../partials/head'); %>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <!-- Custom styling -->
    <%- compiled_stylesheet_tag('PLR.css') %>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="img/favicon/favicon.ico" />
    <!-- Google Icons -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
  </head>
  <!-- BODY -->
  <body>
    <%- include('../partials/navbar', {navPage: ''}); %>

    <!-- Main content -->
    <main class="container">
      <div class="row">
        <!-- First column: Scoreboards -->
        <div class="col-md-7">
          <!-- <form action="/join-session" method="post">
            <button id="join-session-btn" class="btn btn-dark rounded-pill join-session" id="nav-join-session-tab" type="submit" role="tab" aria-controls="nav-join-session" aria-selected="false">
              Join Live Session
            </button>
          </form> -->
          <a
            href="/join-session"
            class="btn btn-dark rounded-pill join-session mb-3"
            id="nav-join-session-tab"
            role="tab"
            aria-controls="nav-join-session"
            aria-selected="false"
          >
            Join Live Session
          </a>
          <!-- Tabs to navigate between scoreboards -->
          <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
              <!-- Tab 1: Live Scoreboard -->
              <button
                class="nav-link active scoreboard"
                id="nav-live-scoreboard-tab"
                data-bs-toggle="tab"
                data-bs-target="#nav-live-scoreboard"
                type="button"
                role="tab"
                aria-controls="nav-live-scoreboard"
                aria-selected="true"
              >
                Live Scoreboard
              </button>
              <!-- Tab 2: Seasonal Scoreboard -->
              <button
                class="nav-link scoreboard"
                id="nav-seasonal-scoreboard-tab"
                data-bs-toggle="tab"
                data-bs-target="#nav-seasonal-scoreboard"
                type="button"
                role="tab"
                aria-controls="nav-seasonal-scoreboard"
                aria-selected="false"
              >
                Seasonal Scoreboard
              </button>
              <!-- Tab 3: All-Time Scoreboard -->
              <button
                class="nav-link scoreboard"
                id="nav-all-time-scoreboard-tab"
                data-bs-toggle="tab"
                data-bs-target="#nav-all-time-scoreboard"
                type="button"
                role="tab"
                aria-controls="nav-all-time-scoreboard"
                aria-selected="false"
              >
                All-Time Scoreboard
              </button>
            </div>
          </nav>
          <div class="tab-content" id="nav-tabContent">
            <!-- TAB 1: Live Scoreboard -->
            <%- include('../partials/plr/liveScoreboard.ejs'); %>
            <!-- TAB 2: Seasonal Scoreboard -->
            <%- include('../partials/plr/seasonalScoreboard.ejs'); %>
            <!-- TAB 3: All-Time Scoreboard -->
            <%- include('../partials/plr/allTimeScoreboard.ejs'); %>
          </div>
        </div>
        <!-- End first column... -->
        <!-- Second column: Profile Card -->
        <div class="maincardcontainer col-md-5 mt-3">
          <div class="card container p-3" id="profile-card">
            <!-- Row 1: Include profile icon, name, and rank in the semester -->
            <div class="row">
              <h5>
                <span class="material-symbols-outlined align-bottom px-2"> person </span>
                {Display Name}
              </h5>
            </div>
            <!-- Row 2: Display Name -->
            <div class="row">
              <form method="post" action="" class="form mb-4">
                <input type="text" />
                <!-- Submission of form -->
                <button type="submit" class="btn btn-outline-light btn-sm px-2">
                  Change Display Name
                </button>
              </form>
            </div>
            <!-- Row 2: Displayed Badges -->
            <div class="row py-2" id="badge-display">
              <div class="col my-auto">
                <h5>Displayed Badges</h5>
                <span class="material-symbols-outlined align-bottom px-2"> elderly </span>
                <span class="material-symbols-outlined align-bottom px-2"> rocket_launch </span>
                <span class="material-symbols-outlined align-bottom px-2"> school </span>
              </div>
            </div>
            <!-- Row 3: Achievements -->
            <div class="row py-2 mt-3" id="badge-display">
              <div class="col my-auto"><%- include('../partials/plr/achievementList.ejs'); %></div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Establish an SSE connection
      const source = new EventSource('/sse');

      // Receive the list of connected users from the server
      source.addEventListener(
        'connected',
        function (event) {
          const data = JSON.parse(event.data);
          const currentUserElement = document.getElementById('current-user');
          currentUserElement.textContent = `Connected users: ${data.length}`;
        },
        false,
      );

      // Receive score updates from the server
      source.addEventListener(
        'scores',
        function (event) {
          const data = JSON.parse(event.data);
          updateScores(data);
        },
        false,
      );

      // Function to update the scores in the table
      function updateScores(scores) {
        const tableBody = document.querySelector('tbody');
        tableBody.innerHTML = '';
        if (scores.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.setAttribute('colspan', '5');
          cell.textContent = 'No live scores available.';
          row.appendChild(cell);
          tableBody.appendChild(row);
        }
        scores.forEach((score, index) => {
          const row = document.createElement('tr');
          const rankCell = document.createElement('th');
          const nameCell = document.createElement('td');
          const achievementCell = document.createElement('td');
          const scoreCell = document.createElement('td');
          const timeCell = document.createElement('td');
          rankCell.setAttribute('scope', 'row');
          rankCell.textContent = index + 1;
          nameCell.textContent = score.name;
          achievementCell.textContent = score.achievements;
          scoreCell.textContent = score.score;
          var time = score.time;
          var dateFormatTime = new Date(time);
          timeCell.textContent =
            dateFormatTime.getHours() +
            ':' +
            dateFormatTime.getMinutes() +
            ':' +
            dateFormatTime.getSeconds();
          row.appendChild(rankCell);
          row.appendChild(nameCell);
          row.appendChild(achievementCell);
          row.appendChild(scoreCell);
          row.appendChild(timeCell);
          tableBody.appendChild(row);
        });
      }
      window.addEventListener('beforeunload', function () {
        // Create a new request
        var req = new XMLHttpRequest();

        // Initialize the request
        req.open('POST', '/sse/close', false); // `false` makes the request synchronous

        // Get the clientId from the cookie
        var clientId = document.cookie.replace(
          /(?:(?:^|.*;\s*)clientId\s*=\s*([^;]*).*$)|^.*$/,
          '$1',
        );

        // Send the client's ID in the body of the request
        req.send(JSON.stringify({ id: clientId }));
      });
    </script>
  </body>
</html>
